<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Plan - {{ plan.destination if plan else 'Not Found' }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* Print styles for PDF export */
        @media print {
            body { margin: 0; padding: 20px; }
            .no-print { display: none !important; }
            .plan-card { box-shadow: none; border: 1px solid #ddd; }
            .map-container { height: 300px; }
        }
        
        .share-header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 30px;
        }
        
        .share-header h1 {
            margin: 0;
            font-size: 2.5rem;
        }
        
        .share-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        
        .share-actions {
            text-align: center;
            margin: 20px 0;
        }
        
        .share-actions .btn {
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Share Header -->
        <header class="share-header">
            <h1><i class="fas fa-plane"></i> AI Travel Planner</h1>
            <p>Shared Travel Plan</p>
        </header>

        <!-- Plan Content -->
        <main class="main-content">
            <div class="plan-card">
                <div class="plan-header">
                    <h2 class="plan-title">
                        {% if plan and plan.name %}
                            üëã Hi {{ plan.name }}, here‚Äôs your Smart Travel Plan!
                        {% else %}
                            {{ plan.destination }}
                        {% endif %}
                    </h2>
                    <div class="plan-meta">
                        {% if plan.country or plan.state %}
                        <span class="plan-location">{{ (plan.city if plan.city else '') }}{% if plan.city and (plan.state or plan.country) %}, {% endif %}{{ plan.state if plan.state else '' }}{% if plan.state and plan.country %}, {% endif %}{{ plan.country if plan.country else '' }}</span>
                        {% endif %}
                        <span class="plan-days">{{ plan.days }} days</span>
                        <span class="plan-mood">
                            {% if plan.mood == 'relaxing' %}üòå
                            {% elif plan.mood == 'adventurous' %}üèîÔ∏è
                            {% elif plan.mood == 'foodie' %}üçΩÔ∏è
                            {% elif plan.mood == 'romantic' %}üíï
                            {% elif plan.mood == 'family' %}üë®‚Äçüë©‚Äçüëß‚Äçüë¶
                            {% else %}üéí{% endif %}
                        </span>
                        <span class="plan-date">{{ (plan.created_at.strftime('%B %d, %Y') if plan.created_at.__class__.__name__ == 'datetime' else plan.created_at) }}</span>
                    </div>
                </div>

                <!-- Weather Section -->
                {% if plan and plan.weather %}
                <div class="weather-section">
                    <h4><i class="fas fa-cloud-sun"></i> Weather Forecast</h4>
                    <div class="weather-forecast">
                        {% for day in plan.weather %}
                        <div class="weather-day">
                            <h5>{{ day.day }}</h5>
                            <div class="temp">{{ day.temperature }}</div>
                            <div class="forecast">{{ day.forecast }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Attractions Section -->
                {% if plan and plan.attractions %}
                <div class="attractions-section">
                    <h4><i class="fas fa-landmark"></i> Must-Visit Attractions</h4>
                    <div class="attractions-grid">
                        {% for attraction in plan.attractions %}
                        <div class="attraction-card">
                            <img src="{{ attraction.image or '/static/placeholder.jpg' }}" alt="{{ attraction.name }}" class="attraction-image">
                            <div class="attraction-info">
                                <h5 class="attraction-name">{{ attraction.name }}</h5>
                                <p class="attraction-description">{{ attraction.description or attraction.summary or 'No description available' }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Hotels Section -->
                {% if plan and plan.hotels %}
                <div class="hotels-section">
                    <h4><i class="fas fa-bed"></i> Hotel Recommendations</h4>
                    <div class="hotels-grid">
                        {% for hotel in plan.hotels %}
                        <div class="hotel-card">
                            <img src="{{ hotel.image or '/static/placeholder.jpg' }}" alt="{{ hotel.name }}" class="hotel-image">
                            <div class="hotel-info">
                                <h5 class="hotel-name">{{ hotel.name }}</h5>
                                <p class="hotel-budget">
                                    {% if hotel.budget_in_inr %}
                                        ‚Çπ{{ "{:,.0f}".format(hotel.budget_in_inr) }}
                                    {% elif hotel.price_in_inr_est %}
                                        ‚Çπ{{ "{:,.0f}".format(hotel.price_in_inr_est) }}
                                    {% elif hotel.budget_range_inr %}
                                        {{ hotel.budget_range_inr }}
                                    {% else %}
                                        Price not available
                                    {% endif %}
                                </p>
                                {% if hotel.link or hotel.source_url %}
                                <a href="{{ hotel.link or hotel.source_url }}" class="hotel-link" target="_blank">
                                    <i class="fas fa-external-link-alt"></i> View on Map
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Map Section -->
                <div class="map-section">
                    <h4><i class="fas fa-map-marker-alt"></i> Interactive Map</h4>
                    <div class="map-container" id="map">
                        <div class="map-placeholder">
                            <i class="fas fa-map"></i>
                            <p>Map loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Daily Itinerary Section -->
                {% if plan and plan.itinerary %}
                <div class="itinerary-section">
                    <h4><i class="fas fa-list"></i> Daily Itinerary</h4>
                    <div class="daily-itinerary">
                        {% macro slot_text(slot) -%}
                            {%- if slot is string -%}{{ slot }}
                            {%- elif slot.activity is string -%}{{ slot.activity }}
                            {%- elif slot.suggestion -%}{{ slot.suggestion }}
                            {%- elif slot.name -%}{{ slot.name }}
                            {%- elif slot.title -%}{{ slot.title }}
                            {%- elif slot.content -%}{{ slot.content }}
                            {%- elif slot.poi and slot.poi.name -%}{{ slot.poi.name }}
                            {%- else -%}{%- endif -%}
                        {%- endmacro %}

                        {% if plan.itinerary is iterable and plan.itinerary.__class__.__name__ != 'str' %}
                            {% for day in plan.itinerary %}
                            <div class="day-card">
                                <div class="day-header">
                                    <div class="day-number">{{ loop.index }}</div>
                                    <span>Day {{ loop.index }}</span>
                                </div>
                                <div class="day-activities">
                                    <div class="activity-item"><div class="activity-time">Morning</div><div class="activity-content">{{ slot_text(day.morning) }}</div></div>
                                    <div class="activity-item"><div class="activity-time">Afternoon</div><div class="activity-content">{{ slot_text(day.afternoon) }}</div></div>
                                    <div class="activity-item"><div class="activity-time">Evening</div><div class="activity-content">{{ slot_text(day.evening) }}</div></div>
                                    <div class="activity-item"><div class="activity-time">Dinner</div><div class="activity-content">{{ slot_text(day.dinner) }}</div></div>
                                    <div class="activity-item"><div class="activity-time">Accommodation</div><div class="activity-content">{{ slot_text(day.accommodation) }}</div></div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <pre style="white-space: pre-wrap;">{{ plan.itinerary }}</pre>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% if plan and plan.packing_list %}
                <div class="packing-section">
                    <h4><i class="fas fa-suitcase-rolling"></i> üß≥ Your Smart Packing List</h4>
                    {% if plan.name %}
                    <div class="packing-greeting">
                        <div class="greeting-text">Hi {{ plan.name }}, here is your personalized packing list ‚ú®</div>
                    </div>
                    {% endif %}
                    <ul class="packing-list">
                        {% for item in plan.packing_list %}
                        <li class="pill">{{ item }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Share Actions -->
                <div class="share-actions no-print">
                    <button class="btn btn-primary" onclick="window.print()">
                        <i class="fas fa-file-pdf"></i> Export as PDF
                    </button>
                    <button class="btn btn-secondary" onclick="copyToClipboard()">
                        <i class="fas fa-copy"></i> Copy Plan
                    </button>
                    <a href="mailto:?subject=Check out my travel plan!&body=I created a travel plan using AI Travel Planner. View it here: {{ request.url }}" class="btn btn-info">
                        <i class="fas fa-envelope"></i> Share via Email
                    </a>
                    <a href="https://wa.me/?text=Check out my travel plan: {{ request.url }}" class="btn btn-success" target="_blank">
                        <i class="fab fa-whatsapp"></i> Share via WhatsApp
                    </a>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Initialize map with plan data
        document.addEventListener('DOMContentLoaded', function() {
            const map = L.map('map').setView([0, 0], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            const bounds = L.latLngBounds();
            
            // Add markers for attractions
            {% if plan and plan.pois %}
            {% for attraction in plan.pois %}
            {% if attraction.lat and attraction.lon %}
            const marker{{ loop.index }} = L.marker([{{ attraction.lat }}, {{ attraction.lon }}], {
                icon: L.divIcon({
                    className: 'custom-marker poi-marker',
                    html: '<i class="fas fa-landmark"></i>',
                    iconSize: [30, 30]
                })
            }).addTo(map);
            
            marker{{ loop.index }}.bindPopup(`
                <div class="map-popup">
                    <h5>{{ attraction.name }}</h5>
                    <p>{{ attraction.description or attraction.summary or '' }}</p>
                </div>
            `);
            
            bounds.extend([{{ attraction.lat }}, {{ attraction.lon }}]);
            {% endif %}
            {% endfor %}
            {% endif %}
            
            // Add markers for hotels
            {% if plan and plan.hotels %}
            {% for hotel in plan.hotels %}
            {% if hotel.lat and hotel.lon %}
            const hotelMarker{{ loop.index }} = L.marker([{{ hotel.lat }}, {{ hotel.lon }}], {
                icon: L.divIcon({
                    className: 'custom-marker hotel-marker',
                    html: '<i class="fas fa-bed"></i>',
                    iconSize: [30, 30]
                })
            }).addTo(map);
            
            hotelMarker{{ loop.index }}.bindPopup(`
                <div class="map-popup">
                    <h5>{{ hotel.name }}</h5>
                    <p>{% if hotel.budget_in_inr %}‚Çπ{{ "{:,.0f}".format(hotel.budget_in_inr) }}{% elif hotel.price_in_inr_est %}‚Çπ{{ "{:,.0f}".format(hotel.price_in_inr_est) }}{% elif hotel.budget_range_inr %}{{ hotel.budget_range_inr }}{% else %}Price not available{% endif %}</p>
                </div>
            `);
            
            bounds.extend([{{ hotel.lat }}, {{ hotel.lon }}]);
            {% endif %}
            {% endfor %}
            {% endif %}
            
            // Fit map to bounds if we have markers
            if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [20, 20] });
            } else {
                map.setView([20, 0], 2);
            }
        });
        
        // Copy plan to clipboard
        function copyToClipboard() {
            const planText = `
AI Travel Planner - {{ plan.destination if plan else '' }}

Duration: {{ plan.days if plan else '' }} days
Mood: {{ plan.mood if plan else '' }}
Created: {{ (plan.created_at.strftime('%B %d, %Y') if plan and plan.created_at.__class__.__name__ == 'datetime' else plan.created_at if plan else '') }}

ITINERARY:
{{ (plan.itinerary | tojson(indent=2)) if plan else 'No itinerary available' }}

View full plan: {{ request.url }}
            `.trim();
            
            navigator.clipboard.writeText(planText).then(() => {
                alert('Plan copied to clipboard!');
            }).catch(() => {
                alert('Error copying plan');
            });
        }
        
        // Add custom CSS for map markers
        const style = document.createElement('style');
        style.textContent = `
            .custom-marker {
                background: white;
                border: 2px solid #007bff;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #007bff;
                font-size: 14px;
            }
            
            .hotel-marker {
                border-color: #28a745;
                color: #28a745;
            }
            
            .map-popup {
                text-align: center;
            }
            
            .map-popup h5 {
                margin: 0 0 5px 0;
                color: #333;
            }
            
            .map-popup p {
                margin: 0;
                color: #666;
                font-size: 12px;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
